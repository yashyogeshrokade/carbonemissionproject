<script>
  async function loadBuildingDetails() {
    const building = localStorage.getItem("selectedBuilding");
    const type = localStorage.getItem("selectedType");

    if (!building || !type) {
      alert("No building data found. Redirecting...");
      window.location.href = "index.html";
      return;
    }

    document.getElementById("buildingTitle").textContent = building;
    document.getElementById("buildingType").textContent = type.toUpperCase();

    try {
      const response = await fetch("energy.xlsx");
      if (!response.ok) throw new Error("Excel file not found.");

      const data = await response.arrayBuffer();
      const workbook = XLSX.read(data, { type: "array" });
      const sheetName = "Sheet1"; // Academic buildings in your case
      const sheet = workbook.Sheets[sheetName];
      const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      const monthNames = [
        "Jan-25","Feb-25","Mar-25","Apr-25","May-25","Jun-25",
        "Jul-25","Aug-25","Sep-25"
      ];

      let found = false;
      let monthlyValues = [];
      let totalValue = "N/A";

      for (let i = 3; i < jsonData.length; i++) {
        const row = jsonData[i];
        if (!row || row.length < 15) continue;

        const buildingName = row[1];
        if (
          buildingName &&
          buildingName.toString().trim().toLowerCase() === building.trim().toLowerCase()
        ) {
          monthlyValues = row.slice(2, 11).map(v => parseFloat(v) || 0);
          totalValue = row[14] || "N/A";
          found = true;
          break;
        }
      }

      document.getElementById("energyValue").textContent = totalValue.toLocaleString();
      document.getElementById("carbonValue").textContent = found ? "0" : "N/A";

      if (found) {
        renderPieChart(monthNames, monthlyValues);
      } else {
        console.warn("Building not found in Excel sheet.");
      }
    } catch (err) {
      console.error(err);
      document.getElementById("energyValue").textContent = "Error loading data";
      document.getElementById("carbonValue").textContent = "Error";
    }
  }

  function renderPieChart(labels, data) {
    const ctx = document.getElementById("energyChart").getContext("2d");
    new Chart(ctx, {
      type: "pie",
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: [
            "#f94144","#f3722c","#f8961e","#f9844a","#f9c74f",
            "#90be6d","#43aa8b","#577590","#277da1"
          ],
          borderWidth: 1
        }]
      },
      options: {
        plugins: {
          legend: {
            position: "bottom",
            labels: { font: { size: 14 } }
          },
          title: {
            display: true,
            text: "Monthly Energy Consumption (kWh)",
            font: { size: 18 }
          }
        }
      }
    });
  }

  function goBack() {
    window.location.href = "index.html";
  }

  window.onload = loadBuildingDetails;
</script>
